const API="https://myanime-app.appspot.com",LOADING_PROFILE="load-fig.gif",DEFAULT_PROFILE="mal.jpg";let watching=$("#watching"),onHold=$("#on-hold"),planToWatch=$("#plan-to-watch");var user,userIcon,provider,filter,filterType,tasks=0,animes=[],airingAnimes={},calendarFetched=!1;let providerOffsets={myanimelist:0,"lucky-es":0,"google-es":0,"lucky-en":0,"google-en":0,animeid:3,animeflv:2,jkanime:5,monoschinos:3,twist:3,gogoanime:2,crunchyroll:1,netflix:0},providers={myanimelist:"https://myanimelist.net/","lucky-es":"https://duckduckgo.com/","google-es":"https://www.google.es/","lucky-en":"https://duckduckgo.com/","google-en":"https://www.google.com/",animeid:"https://www.animeid.tv/",animeflv:"https://animeflv.net/",jkanime:"http://jkanime.net/",monoschinos:"https://monoschinos.com/",twist:"https://twist.moe/",gogoanime:"https://www2.gogoanime.se/",crunchyroll:"https://www.crunchyroll.com/",netflix:"https://www.netflix.com/"};function loading(e){tasks+=e?1:-1,changeProfile(tasks>0?LOADING_PROFILE:userIcon||DEFAULT_PROFILE)}function finishLoading(e){let i=function(){loading(!1)};return Object.defineProperty(i,"name",{value:e}),i}function fetchCalendar(){return new Promise((function(e,i){calendarFetched?e():get(API+"/calendar",((i,t,n)=>{for(anime of n.airingAnimes)airingAnimes[idify(anime.title)]={episode:anime.episode,airingDate:luxon.DateTime.fromISO(anime.date)};e()}),((e,t)=>{e=e||"The server does not respond.",i({message:`Cannot get calendar, reason: ${e}`,status:t})}))}))}function cannotFetchCalendar(){return e=>{var i=e.message||e;(e.status>0||filter>=0)&&alert(i+"\n\nFilter is showing episodes regardless of whether or not it has been aired."),console.warn(i)}}function watchAnime(e,i,t,n,a){function r(){function r(e){return n?" ":e}function o(e){return r(` inurl:${e} `)}function s(){return encodeURIComponent(`${e}${o(i)}online español -english`)}function l(){return encodeURIComponent(`${e}${r(` episode${o(i)}`)}online english anime -español`)}let d=providers[provider];return"myanimelist"==provider?`${d}anime/${t}/${a&&!n?`-/episode/${i}`:""}`:"lucky-es"==provider?`${d}?q=!ducky+`+s():"google-es"==provider?`${d}search?btnI&q=`+s():"lucky-en"==provider?`${d}?q=!ducky+`+l():"google-en"==provider?`${d}search?btnI&q=`+l():"animeid"==provider?`${d}v/${asUrl(e,i)}`:"animeflv"==provider?"https://duckduckgo.com/?q=!ducky+"+encodeURIComponent(`site:animeflv.net ${e} ${i}`):"jkanime"==provider?`${d}${asUrl(e)}/${i}/`:"monoschinos"==provider?`${d}ver/${asUrl(e,i)}`:"twist"==provider?`${d}a/${asUrl(e)}/${i}`:"gogoanime"==provider?`${d}${asUrl(e,`episode-${i}`)}`:"crunchyroll"==provider?`${d}search?q=${encodeURI(`${e} ${i}`)}`:"netflix"==provider?`${d}search?q=${encodeURI(e)}`:void 0}let o=r();console.log(o),window.open(o)}function getAnimeFigure(e,i,t,n,a,r,o,s,l,d){let c=e,p=isAired(e,t,s,l);var m;p||(m=getFormattedAiringDate(l,t)),d(`<article id="anime-${r}">\n    <div>\n      <header>${c} #${t}${m?`<br><br>${m}`:""}</header>\n      <figure>\n        <img src="${a}" class="cover" width="225" height="313">\n      </figure>\n      <aside>\n        <span id="next-${r}" class="p" data-toggle="tooltip" data-placement="top" title="Mark this episode as watched in your MyAnimeList profile.">Next</span>\n      </aside>\n    </div>\n  </article>`),$(`#anime-${r} div`).click((function(){watchAnime(c,t,r,o,p)})),$(`#next-${r}`).click((function(){updateChapter(event,c,i,t,n,a,r,o,s,l)}))}function emptyAnime(){watching.empty(),onHold.empty(),planToWatch.empty()}var airingAnime,checkpoint;function getFormattedAiringDate(e,i){return airingAnime?formatDateTime(airingDate()):e?formatDate(estimatedAiringDate(e,i)):void 0}function airingDate(){return airingAnime.airingDate.plus({hours:providerOffsets[provider]})}function estimatedAiringDate(e,i){return e.plus({weeks:i-1})}function isAired(e,i,t,n){function a(){return airingAnime.episode>i||airingAnime.episode==i&&airingDate()<now()}var r;return airingAnime=void 0,1==t?(e=idify(e),calendarFetched&&e in airingAnimes?(airingAnime=airingAnimes[e],r=a(airingAnime)):r=!!n&&estimatedAiringDate(n,i)<=now()):r=2==t,r}function emptyAndParseAnime(){emptyAnime(),parseAnime()}function parseAnime(e){loading(!0);let i=e||animes;for(anime of i){let e=anime.watching_status;if(2!=e&&4!=e){let i=anime.airing_status,r=anime.type,o=anime.total_episodes,s=anime.watched_episodes+1;var t;if((0==o||s<=o)&&(filter<=0||7==filter||filterType==r))if(1==e?t=watching:3==e?t=onHold:6==e&&(t=planToWatch),t){let e=anime.title;var n="";anime.start_date&&(n=luxon.DateTime.fromISO(anime.start_date));var a=filter<0||isAired(e,s,i,n);7==filter&&(a=!a),a&&getAnimeFigure(e,[],s,o,anime.image_url,anime.mal_id,"Movie"==r,i,n,(function(e){t.append(e)}))}}}loading(!1)}function fetchAnimes(){function e(i){loading(!0),get(`https://api.jikan.moe/v3/user/${user}/animelist/${i}`,((e,i,t)=>{let n=t.anime||[];animes.push(...n),parseAnime(n)}),((t,n)=>{429==n&&setTimeout((function(){e(i)}),2e3)})).always(finishLoading(`Fetch Animes ${i} Finish`))}animes=[],watching.empty(),e("watching"),onHold.empty(),e("onhold"),planToWatch.empty(),e("ptw")}function changeProfile(e){$("#profile-link").attr("href",`https://myanimelist.net/profile/${user}`),$("#profile-icon").attr("src",e)}function searchUser(){function e(e){404==e&&(alert(`User ${user} does not exists.`),storage.remove("user"))}return user=$("#search-user").val(),user&&(loading(!0),get(`https://api.jikan.moe/v3/user/${user}`,((e,i,t)=>{fetchAnimes(),userIcon=t.image_url,changeProfile(userIcon),storage.set("user",user)}),((i,t)=>{e(t)})).always(finishLoading("Search User Finish"))),!1}function updatePassword(){let e=$("#password").val().trim();""!=e&&($("#set-password").modal("hide"),storage.set("password",e),checkpoint())}function updateAnime(e,i,t,n,a,r,o,s,l){let d=animes.findIndex((e=>e.mal_id==r)),c=animes[d];function p(){$(`#anime-${r}`).remove(),animes.splice(d,1)}let m={id:r,episode:t};1==t&&(m.status=1,m.date_start=formatTodayRaw());let u=t==n;if(u&&(m.status=2,m.date_finished=formatTodayRaw()),window.open(c.url,"_blank"),u)p(),alert(`Hooray! You've completed ${e}!`);else if(isAired(e,t+1,s,l))getAnimeFigure(e,i,t+1,n,a,r,o,s,l,(function(e){$(`#anime-${r}`).replaceWith(e)})),c.watching_status=m.status||c.watching_status,c.watched_episodes=t,alert(`Updated ${e} to episode ${t}.`);else{p();let i=`Updated ${e} to episode ${t}.`,n=getFormattedAiringDate(l,t+1);n&&(i+=` Next episode will be available: ${n}.`),alert(i)}}function updateChapter(e,i,t,n,a,r,o,s,l,d){loading(!0),updateAnime(i,t,n,a,r,o,s,l,d),loading(!1),e.stopPropagation()}function updateChapterAPI(e,i,t,n,a,r,o,s,l,d){let c=storage.get("password");if(null==c)checkpoint=function(){updateChapterAPI(e,i,t,n,a,r,o,s,l,d)},$("#set-password").modal("show");else{loading(!0);let m=updateAnime(i,t,n,a,r,o,s,l,d);function p(e){storage.remove("password"),e=e||"The server does not respond.",alert(`Cannot update episode, reason: ${e}`)}post(API+"/update",JSON.stringify(m),((e,i)=>{"Updated"===e?updateAnime():p(e)}),p,auth(user,c).and(contentType("application/json"))).always(finishLoading("Update Chapter Finish"))}e.stopPropagation()}$(document).ready((function(){$('[data-toggle="tooltip"]').tooltip(),function(){loading(!0);let e=storage.get("recurrentUser");e||($("#info").modal("show"),storage.set("recurrentUser",!0)),storage.with("provider",(function(e){$("#provider-selector").val(e).change()})),provider=$("#provider-selector").val(),$("#provider-link").attr("href",providers[provider]),$("#provider-selector").on("change",(function(){provider=$(this).val(),$("#provider-link").attr("href",providers[provider]),storage.set("provider",provider),7==filter&&emptyAndParseAnime()}));let i=$("#filter-selector");storage.with("filter",(function(e){i.val(e).change()})),filter=parseInt(i.val()),filterType=$("#filter-selector option:selected").text(),i.on("change",(function(){filter=parseInt(i.val()),filterType=$("#filter-selector option:selected").text(),storage.set("filter",filter),emptyAndParseAnime()})),storage.with("user",(function(e){$("#search-user").val(e).change()})),searchUser(),loading(!1)}()})),$("#search-user-form").submit((function(e){searchUser(),e.preventDefault()})),$("#submitBtn").click(searchUser),$("#update-password-btn").click(updatePassword);